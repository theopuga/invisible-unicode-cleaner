<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invisible Unicode Cleaner</title>
  <style>
    :root { --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; --card:#111827; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    html,body{height:100%}
    /* Ensure elements don't overflow their containers */
    *, *::before, *::after { box-sizing:border-box; }
    body{margin:0;background:linear-gradient(180deg,#0b1022,#0f172a);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    h1{font-size:clamp(20px,4vw,32px);margin:0 0 12px;letter-spacing:.3px}
    p.subtitle{margin:0 0 18px;color:var(--muted)}
    .card{background:rgba(17,24,39,.7);backdrop-filter:saturate(140%) blur(6px);border:1px solid rgba(148,163,184,.18);border-radius:16px;padding:18px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    textarea{width:100%;max-width:100%;min-height:180px;resize:vertical;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--fg);padding:12px 14px;font-size:14px;line-height:1.45;display:block}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 320px}
    .btn{appearance:none;border:1px solid rgba(148,163,184,.3);background:#0b1220;color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:var(--accent);box-shadow:0 0 0 3px rgba(34,211,238,.15)}
    .btn.primary{background:linear-gradient(135deg,#0891b2,#22d3ee);color:#06131a;border:none}
    .btn.ghost{background:transparent}
    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .badge{font-size:12px;padding:6px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.3);color:var(--muted)}
    .badge.ok{border-color:rgba(34,197,94,.45);color:#a7f3d0}
    .badge.warn{border-color:rgba(245,158,11,.45);color:#fde68a}
    .badge.bad{border-color:rgba(239,68,68,.45);color:#fecaca}
    details{margin-top:8px}
    summary{cursor:pointer;color:var(--accent)}
    code{background:#0b1220;border:1px solid rgba(148,163,184,.25);padding:2px 6px;border-radius:6px}
    .footer{margin-top:22px;color:var(--muted);font-size:12px}
    .hl{background:rgba(239,68,68,.25);border-bottom:2px dotted rgba(239,68,68,.8);display:inline-block;padding:0 4px;margin:-1px 0;border-radius:4px;font-size:11px;line-height:1.2;vertical-align:baseline}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    label{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    input[type="file"]{display:none}
    .filelabel{border:1px dashed rgba(148,163,184,.35);padding:10px 12px;border-radius:12px;cursor:pointer}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px}
    /* Tooltip system */
    .info-wrap{position:relative;display:inline-flex;align-items:center;gap:6px}
    .info-icon{background:var(--accent);color:#06131a;border-radius:50%;width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;user-select:none}
    .tooltip{position:absolute;left:0;top:calc(100% + 8px);background:var(--card);color:var(--fg);padding:8px 10px;border-radius:8px;border:1px solid rgba(148,163,184,.3);font-size:12px;max-width:300px;line-height:1.35;z-index:100;opacity:0;visibility:hidden;transform:translateY(-4px);transition:opacity .12s ease, transform .12s ease, visibility .12s ease;pointer-events:none}
    .tooltip.show{opacity:1;visibility:visible;transform:translateY(0);pointer-events:auto}
    .hint{color:var(--muted);font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Invisible Unicode Cleaner</h1>
    <p class="subtitle">Paste text below and remove zero-width, bidi controls, BOM, soft hyphens, and other sneaky characters. Runs 100% in your browser.</p>

    <div class="card grid">
      <div>
        <div class="tools">
          <label class="filelabel"><input id="file" type="file" accept="text/*,.txt,.md,.csv,.json,.docx,.pdf"/>Import .txt/.docx/.pdf</label>
          <button class="btn" id="sample">Insert sample</button>
          <button class="btn ghost" id="highlightBtn">Highlight invisibles</button>
        </div>
      </div>
      <textarea id="input" placeholder="Paste your text here…"></textarea>
      <div class="row">
        <div class="card">
          <div class="stack" id="stats"></div>
          <details>
            <summary>Show detailed report</summary>
            <pre id="report" class="mono small"></pre>
          </details>
          <div style="margin-top:10px;display:flex;gap:14px;flex-wrap:wrap;align-items:center">
            <span class="info-wrap">
              <label><input type="checkbox" id="stripControls"> Also strip other control chars (C0/C1, keeps tab/newline)</label>
              <span class="info-icon" id="ctrlInfo" tabindex="0" aria-label="About control characters">?</span>
              <span class="tooltip" id="tooltipCTRL">Control characters are non-printable codes (ASCII 0x00–0x1F & 0x7F–0x9F). Enabling this removes them (e.g., NUL, BEL, ESC/device controls) while keeping useful ones like TAB, LF, and CR. Helps fix weird copy/paste artifacts from PDFs/terminals.</span>
            </span>

            <span class="info-wrap">
              <label><input type="checkbox" id="normalize" checked> Normalize to NFC (recommended)</label>
              <span class="info-icon" id="nfcInfo" tabindex="0" aria-label="About NFC normalization">?</span>
              <span class="tooltip" id="tooltipNFC">NFC (Normalization Form C) merges decomposed characters into single composed ones. Example: <code>e</code> + <code>◌́</code> → <code>é</code>. Makes visually identical text compare/search the same across systems.</span>
            </span>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button class="btn" id="analyze">Analyze text</button>
            <span class="hint">Tip: Press <b>Ctrl/⌘ + Enter</b> to analyze (input window needs to be selected)</span>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn primary" id="clean">Clean text</button>
            <button class="btn" id="copy">Copy cleaned</button>
            <button class="btn" id="download">Download .txt</button>
          </div>
        </div>
        <textarea id="output" placeholder="Cleaned text appears here…"></textarea>
      </div>
      <div class="footer">
        <div>Characters removed by default: <code>ZWSP(\u200B)</code>, <code>ZWNJ(\u200C)</code>, <code>ZWJ(\u200D)</code>, <code>WJ(\u2060)</code>, <code>BOM/ZWNBSP(\uFEFF)</code>, <code>SOFT HYPHEN(\u00AD)</code>, <code>LRM/RLM(\u200E/\u200F)</code>, bidi controls <code>\u202A-\u202E</code>, isolates <code>\u2066-\u2069</code>.</div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>What counts as “invisible” here?</summary>
        <p>We target <em>format</em> and <em>directionality</em> code points that commonly sneak into copy/paste: zero-width joins, BOMs, soft hyphens, and bidirectional override/embedding/isolate marks. Optionally, you can also remove generic control characters (0x00–0x1F & 0x7F–0x9F) while keeping tab/newline.</p>
        <p>Tip: Use <b>Highlight invisibles</b> to preview where they are before cleaning.</p>
      </details>
    </div>

  </div>

<!-- Dynamic loader for vendor libs: works both online (CDN) and offline (file:// with local vendor/* files) -->
<script>
  (function(){
    const isFile = location.protocol === 'file:';
    const VENDOR = {
      jszip: isFile ? 'vendor/jszip.min.js' : 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js',
      mammoth: isFile ? 'vendor/mammoth.browser.min.js' : 'https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js',
      pdf: isFile ? 'vendor/pdf.min.js' : 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js',
      pdfWorker: isFile ? 'vendor/pdf.worker.min.js' : 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js'
    };

    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=()=>reject(new Error('Failed to load '+src));
        document.head.appendChild(s);
      });
    }

    // expose a promise others can await
    window.__libsReady = (async ()=>{
      try{
        await loadScript(VENDOR.jszip);
        await loadScript(VENDOR.mammoth);
        await loadScript(VENDOR.pdf);
        // pdf.js requires workerSrc to be set AFTER the main script is present
        window.pdfjsLib = window.pdfjsLib || window['pdfjs-dist/build/pdf'];
        const workerSrc = VENDOR.pdfWorker;
        if(window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions){
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = workerSrc;
        }
      }catch(err){
        console.warn('[vendor loader]', err);
        const bar = document.createElement('div');
        bar.id='envAlert';
        bar.style.cssText='position:fixed;left:16px;right:16px;bottom:16px;background:#fee2e2;color:#111;padding:10px 12px;border:1px solid #fca5a5;border-radius:10px;font:13px system-ui;z-index:9999';
        bar.innerHTML = 'Some libraries failed to load. If you opened this file directly (file://), either run a local server (e.g., <code>python -m http.server</code>) or place local copies in a <code>vendor/</code> folder: <code>jszip.min.js</code>, <code>mammoth.browser.min.js</code>, <code>pdf.min.js</code>, <code>pdf.worker.min.js</code>. PDF import requires these files.';
        document.body.appendChild(bar);
        throw err;
      }
    })();
  })();
</script>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  // Tooltip helpers (fixed below icon with small delays; non-blinking)
  function wireTooltip(iconEl, tipEl){
    let showT=null, hideT=null;
    const show=()=>{clearTimeout(hideT);showT=setTimeout(()=>tipEl.classList.add('show'),120)};
    const hide=()=>{clearTimeout(showT);hideT=setTimeout(()=>tipEl.classList.remove('show'),150)};
    iconEl.addEventListener('mouseenter',show);
    iconEl.addEventListener('mouseleave',hide);
    tipEl.addEventListener('mouseenter',show);
    tipEl.addEventListener('mouseleave',hide);
    iconEl.addEventListener('focus',show);
    iconEl.addEventListener('blur',hide);
    iconEl.addEventListener('click', (e)=>{ e.preventDefault(); tipEl.classList.toggle('show'); });
  }
  wireTooltip($("nfcInfo"), $("tooltipNFC"));
  wireTooltip($("ctrlInfo"), $("tooltipCTRL"));

  // Invisible and control ranges
  const INVISIBLES=["\u200B","\u200C","\u200D","\u2060","\uFEFF","\u00AD","\u200E","\u200F"];
  const RANGES=[[0x202A,0x202E],[0x2066,0x2069]];
  const CTRL_REGEX=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g; // keep TAB/LF/CR

  function buildRegex(includeControls){
    const list = INVISIBLES.map(c=>c).join("");
    const ranges = RANGES.map(([a,b])=>`\\u${a.toString(16).padStart(4,'0')}-\\u${b.toString(16).padStart(4,'0')}`).join("");
    const core = new RegExp(`[${list}${ranges}]`, 'g');
    if (!includeControls) return core;
    return new RegExp(core.source + "|" + CTRL_REGEX.source, 'g');
  }

  function codeName(ch){
    const cp=ch.codePointAt(0);
    const hex="U+"+cp.toString(16).toUpperCase().padStart(4,'0');
    const map={0x200B:"ZWSP",0x200C:"ZWNJ",0x200D:"ZWJ",0x2060:"WJ",0xFEFF:"BOM/ZWNBSP",0x00AD:"SOFT HYPHEN",0x200E:"LRM",0x200F:"RLM",0x202A:"LRE",0x202B:"RLE",0x202C:"PDF",0x202D:"LRO",0x202E:"RLO",0x2066:"LRI",0x2067:"RLI",0x2068:"FSI",0x2069:"PDI"};
    const name = map[cp] || (cp<=0x1F || (cp>=0x7F&&cp<=0x9F) ? "CTRL" : "UNKNOWN");
    return `${name} (${hex})`;
  }

  function analyze(text, includeControls){
    const rx = buildRegex(includeControls);
    const hits = [];
    text.replace(rx, (m, idx)=>{ hits.push({ch:m,index:idx,code:codeName(m)}); return m; });
    const byCode={}; for(const h of hits){ byCode[h.code]=(byCode[h.code]||0)+1; }
    return {hits, byCode, total:hits.length};
  }

  function makeBadges(byCode,total){
    const stats=$("stats"); stats.innerHTML='';
    const totalBadge=document.createElement('div');
    totalBadge.className='badge '+(total?'bad':'ok');
    totalBadge.textContent = total ? `${total} invisible found` : 'No invisibles found';
    stats.appendChild(totalBadge);
    for(const [k,v] of Object.entries(byCode)){
      const b=document.createElement('div'); b.className='badge warn'; b.textContent=`${k}: ${v}`; stats.appendChild(b);
    }
  }

  function makeReport(hits){
    const report=$("report");
    if(!hits.length){ report.textContent=''; return; }
    const lines=hits.slice(0,2000).map(h=>`idx ${h.index}: ${h.code}`);
    report.textContent = lines.join('\n') + (hits.length>2000?`\n… and ${hits.length-2000} more`:'');
  }

  function highlight(text, includeControls){
    const rx = buildRegex(includeControls);
    function esc(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
    let out=''; let last=0; let m;
    while((m=rx.exec(text))){
      const fullName=codeName(m[0]); const shortName=fullName.split(' ')[0];
      out += esc(text.slice(last, m.index));
      out += '<span class="hl" title="'+fullName+'">'+shortName+'</span>';
      last = m.index + m[0].length;
    }
    out += esc(text.slice(last));
    return out;
  }

  function clean(text, includeControls, doNormalize){
    const rx = buildRegex(includeControls);
    let cleaned = text.replace(rx, '');
    if (doNormalize && cleaned.normalize) cleaned = cleaned.normalize('NFC');
    return cleaned;
  }

  // ANALYZE button and shortcut
  function runAnalysis(){
    const t=$("input").value; const includeControls=$("stripControls").checked;
    const res=analyze(t, includeControls);
    makeBadges(res.byCode, res.total); makeReport(res.hits);
  }
  $("analyze").addEventListener('click', runAnalysis);
  $("input").addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      runAnalysis();
    }
  });

  $("clean").addEventListener('click', ()=>{
    const cleaned = clean($("input").value, $("stripControls").checked, $("normalize").checked);
    $("output").value = cleaned;
    // No auto-analysis here; analyze only when user presses Analyze
  });

  $("copy").addEventListener('click', async ()=>{
    const txt = $("output").value || clean($("input").value, $("stripControls").checked, $("normalize").checked);
    await navigator.clipboard.writeText(txt);
  });

  $("download").addEventListener('click', ()=>{
    const txt = $("output").value || clean($("input").value, $("stripControls").checked, $("normalize").checked);
    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cleaned.txt';
    document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  });

  $("highlightBtn").addEventListener('click', ()=>{
    const t=$("input").value; const html=highlight(t, $("stripControls").checked);
    const w=window.open('', '_blank');
    w.document.write(`<!doctype html><meta charset="utf-8"><title>Highlighted Invisibles</title><style>body{font-family:system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f172a;color:#e5e7eb;padding:18px;line-height:1.5}.hl{background:rgba(239,68,68,.25);border-bottom:2px dotted rgba(239,68,68,.8);border-radius:4px;padding:0 4px;font-size:11px}</style><pre>${html}</pre>`);
    w.document.close();
  });

  // File import handler (.txt/.md/.csv/.json, .docx via Mammoth, .pdf via pdf.js)
  // Wait for libs before handling imports
  const libsReady = window.__libsReady || Promise.resolve();

  $("file").addEventListener('change', async (e)=>{
    await libsReady;
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      if(/\.docx$/i.test(f.name)){
        const arrayBuffer = await f.arrayBuffer();
        const { value:text } = await mammoth.extractRawText({ arrayBuffer });
        $("input").value = text || '';
        // analysis deferred
      } else if (/\.pdf$/i.test(f.name)) {
        const arrayBuffer = await f.arrayBuffer();
        const text = await extractPdfText(arrayBuffer);
        $("input").value = text || '';
        // analysis deferred
      } else {
        const reader = new FileReader();
        reader.onload = ()=>{ $("input").value = String(reader.result || ''); /* analysis deferred */ };
        reader.readAsText(f);
      }
    } catch (err) {
      alert('Failed to import file: ' + (err && err.message ? err.message : err));
      console.error(err);
    }
  });

  $("file").addEventListener('click', e=>{ e.target.value = ''; }); // allow re-import same name

  $("sample").addEventListener('click', ()=>{
    $("input").value = "Hello\u200B world!\n\uFEFFThis line starts with a BOM. Soft\u00ADHyphen here. RLM:\u200Fend.\nArabic bidi override test: \u202Etxt\u202C.";
    // analysis deferred
  });

  // ===== Helpers =====
  async function extractPdfText(arrayBuffer){
    const lib = window.pdfjsLib || window['pdfjs-dist/build/pdf'];
    if(!lib){ throw new Error('pdfjsLib not available'); }
    const pdf = await lib.getDocument({ data: arrayBuffer }).promise;
    let out='';
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const parts = content.items.map(it=> (it.str ?? it.text ?? '')).filter(Boolean);
      out += parts.join(' ') + '\n';
    }
    return out;
  }
})();
</script>
</body>
</html>
